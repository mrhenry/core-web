name: pages
on:
  push:
    branches:
    - 'main'

jobs:

  fmt:
    name: pages
    runs-on: ubuntu-latest
    steps:

    - name: check out
      uses: actions/checkout@v2.3.2
      with:
        fetch-depth: 1

    - name: setup node
      uses: actions/setup-node@v2.1.2
      with:
        node-version: 14

    - run: yarn install
    - run: yarn lerna clean -y
    - run: yarn lerna bootstrap
    - run: make generate
    - run: make build-browser-compat

    - run: |
        git fetch --depth=1 origin pages || true

    - name: create pages content
      run: |
        # Git config
        git config user.name github-actions
        git config user.email github-actions@github.com
        # Move contents to temp files
        browsercompatindex=$(mktemp /tmp/browser-compat-index.XXXXXXXXXX)
        echo "$(cat packages/core-web-browser-compat/lib/index.html)" >> $browsercompatindex
        rm packages/core-web-browser-compat/lib/index.html
        # Checkout pages branches
        git checkout pages 2>/dev/null || git checkout -b pages
        # Clean pages branch
        find . -name "node_modules" -type d -prune -exec rm -rf '{}' +
        git ls-files -z | xargs -0 rm -f || true
        git ls-tree --name-only -d -r -z HEAD | sort -rz | xargs -0 rmdir || true
        # Copy contents
        mkdir ./docs
        cp $browsercompatindex ./docs/browsercompat/index.html
        # Submit
        git add .
        git commit -m "update pages"
        git push --set-upstream origin pages
